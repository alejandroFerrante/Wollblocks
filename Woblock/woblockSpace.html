<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <meta name="google" value="notranslate">
  <title>Blockly Demo:</title>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="../../closure/goog/base.js"></script>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  

  <script src="woblockSpace.js"></script>
  <script src="woblocks_blocks.js"></script>

  <style>
  	#box{
	  width: 500px;
	  overflow: hidden;
	  box-shadow: 0 0 10px black;
	  border-radius: 10px;
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%);
	  z-index: 9999;
	  padding: 10px;
	  text-align: center;
	  display: none;
	}
	#box span{
	  font-size: 15px;
	  display: block;
	  margin: 20px 0;
	}
	#box h1{
	  color: brown
	}
	.close{
	  font-size: 18px;
	  color: white;
	  padding: 10px 20px;
	  cursor: pointer;
	  background: rgb(111, 111, 223);
	  display: inline-block;
	  border-radius: 1px solid #000;
	}
  </style>

</head>

<body>

<!-- TABS -->
	<table id="tabsTable">
		<tr><td><button id="sceneTab" class="tabButton" onclick="ontabClick('Scene',-1)" ><b>Escena</b></button></td><td><button id="freeAreaTab" class="tabButton" onclick="ontabClick('FreeArea',-1)">Area Libre</button></td></tr>
		<tr><td><button onclick="showNewTabObjectModal()">+</button></td><td>Objetos</td></tr>
		<tr><td><button onclick="showNewTabBehaviourModal()">+</button></td><td>Comportamientos</td></tr>
	</table>

<!-- MAIN CONTAINER -->
	<table>
  		<tr>
  			<td><div id="blocklyDiv" style="height: 650px; width: 1000px;"></div></td>
  			<td>
  				<div id="sceneDiv" style="height: 650px; width:800px; padding-top:5px;">
  					<h3 style="text-align: center;">Escena</h3>
  				</div>
  			</td>
  		</tr>
  		<tr>
  			<td>
  				<div id="codeDiv" style="height: 250px; width: 1000px;">
  					<h3 style="text-align: center;">Codigo Generado</h3>
  					<button id="code_generate" >Generar</button>
  					<div id="code_container"></div>
  				</div>
  			</td>
		</tr>
	</table>

  <xml xmlns="http://www.w3.org/1999/xhtml" id="workspaceBlocks" style="display:none"></xml>

<!-- MODAL -->
	<div id="box">
	    <i class="fas fa-check-circle"></i> 
	    <h3 id="modalTitle"></h3>
	    <input type="text" id="newGlobalName">
	    <br/><br/>
	    <table style="margin-left: auto;margin-right: auto;">
	    	<tr>
			    <td><button onclick="closeModal()" >cerrar</button></td>
				<td id="createNewTabObjectButton"><button onclick="createNewTabObject()"    >crear</button></td>
				<td id="createNewTabBehaviourButton"><button onclick="createNewTabBehaviour()" >crear</button></td>
	 		</tr>
	 	</table>
	 </div>

<!-- TOOLBOX -->
  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">

    <category name="ATOMICS" toolboxitemid="atomics">

      <block type="logic_boolean" >
        <field name="BOOL">TRUE</field>
      </block>
      
      <block type="math_number" >
        <field name="NUM">123</field>
      </block>
      
      <block type="text" >
        <field name="TEXT"></field>
      </block>
      
      <block type="lists_create_with" >
        <mutation items="0"></mutation>
      </block>

      <block type="lists_create_with">
        <mutation items="1"></mutation>
        <value name="ADD0">
          <block type="text">
            <field name="TEXT"></field>
          </block>
        </value>
      </block>

    </category>

    <category name="CREATION">
          
	  <block type="action_start" >
	  </block>

	  <block type="action_start">
	    <next>
	      <block type="objetc_create">
	        <value name="objName">
	          <block type="text">
	            <field name="TEXT">anObjectName</field>
	          </block>
	        </value>
	        <statement name="properties">
	          <block type="objetc_property">
	            <value name="name">
	              <block type="text">
	                <field name="TEXT">aPropertyName</field>
	              </block>
	            </value>
	            <value name="value">
	              <block type="text">
	                <field name="TEXT">aPropertyValue</field>
	              </block>
	            </value>
	          </block>
	        </statement>
	      </block>
	    </next>
	  </block>

      <block type="objetc_property">
        <value name="name">
          <block type="text">
            <field name="TEXT">aPropertyName</field>
          </block>
        </value>
        <value name="value">
          <block type="text">
            <field name="TEXT">aPropertyValue</field>
          </block>
        </value>
      </block>
 
	 <block type="action_start">
	    <next>
	      <block type="method_create">
	        <value name="name">
	          <block type="text">
	            <field name="TEXT">aMethodName</field>
	          </block>
	        </value>
	        <value name="params">
	          <block type="lists_create_with">
	            <mutation items="0"></mutation>
	          </block>
	        </value>
	        <statement name="instructions">
	          <block type="method_instruction">
	            <value name="instruction">
	              <block type="text">
	                <field name="TEXT">anInstruction</field>
	              </block>
	            </value>
	          </block>
	        </statement>
	      </block>
	    </next>
	  </block>

      <block type="method_instruction">
        <value name="instruction">
          <block type="text">
            <field name="TEXT">anInstruction</field>
          </block>
        </value>
      </block>

      </category>

    <category name="CUSTOM" toolboxitemid="custom" >
    </category>

  </xml>
</body>

<script>

	window.onload = function() {
  		spaceInit();
	};

	$( "#code_generate" ).click(function() {
		$('#code_container')[0].innerHTML = getJSCodeForCurrentWorkspace().replaceAll('\n','<br/>');
	});

	function ontabClick(newTab,newIndex){
		
		if(newTab == 'Scene' || newTab == 'FreeArea' || ( (newTab == 'Object' || newTab == 'Behaviour') && newIndex != currentIndex) ){
			
			//save current content
			if( currentTab == 'Scene' || currentTab == 'FreeArea' ||( (currentTab == 'Object' || currentTab == 'Behaviour') && currentIndex != -1 ) ){ 
				var xmlContentList = null;
				if(currentTab == 'Object'){xmlContentList = definedObjectXmlContent;}
				if(currentTab == 'Behaviour'){xmlContentList = definedBehaviourXmlContent;}
				if(currentTab == 'Scene'){xmlContentList = sceneXmlContent;}
				if(currentTab == 'FreeArea'){xmlContentList = freeAreaXmlContent;}
				if(xmlContentList != undefined && xmlContentList != null){
					var xmlSerializer = new XMLSerializer();
					var contentList = getWorkspaceXmlContentAsList();
					if(currentTab == 'Scene' || currentTab == 'FreeArea'){
						for(var i = 0; i < contentList.length; i++){
							xmlContentList.push(xmlSerializer.serializeToString(contentList[i]));
						}
					}else{
						xmlContentList[currentIndex] = [];
						for(var i = 0; i < contentList.length; i++){
							xmlContentList[currentIndex].push(xmlSerializer.serializeToString(contentList[i]));
						}
					}
				}
			}

			//load new content
			workspace.clear();
			var newContent = null;
			if(newTab == 'Scene' && sceneXmlContent != undefined && sceneXmlContent != null){newContent = sceneXmlContent;}
			if(newTab == 'FreeArea' && freeAreaXmlContent != undefined && freeAreaXmlContent != null){newContent = freeAreaXmlContent;}
			if(newTab == 'Object' && newIndex >= 0 && newIndex < definedObjectXmlContent.length){newContent = definedObjectXmlContent[newIndex];}
			if(newTab == 'Behaviour' && newIndex >= 0 && newIndex < definedBehaviourXmlContent.length){newContent = definedBehaviourXmlContent[newIndex];}
			if(newContent != null && newContent != undefined && newContent.length > 0){
				injectXmlToWorkspace(newContent);
			}

			redrawTabs();

			currentTab = newTab;
			currentIndex = newIndex;
			selectCurrentTab();
		}
		
	}

	function selectCurrentTab(){
		if(currentTab == 'Scene'){document.getElementById('sceneTab').innerHTML = '<b>Escena</b>';}
		if(currentTab == 'FreeArea'){document.getElementById('freeAreaTab').innerHTML = '<b>Area Libre</b>';}
		if(currentTab == 'Object'){document.getElementById('objectButton_'+currentIndex).innerHTML = '<b>'+definedObjectNames[currentIndex]+'</b>';}
		if(currentTab == 'Behaviour'){document.getElementById('behaviourButton_'+currentIndex).innerHTML = '<b>'+definedBehaviourNames[currentIndex]+'</b>';}
	}

	function redrawTabs(){
		var innerHtml = '';
		innerHtml += '<tr>';
		innerHtml += '<tr><td><button id="sceneTab" class="tabButton" onclick="ontabClick(\'Scene\',-1)" >Escena</button></td><td><button id="freeAreaTab" class="tabButton" onclick="ontabClick(\'FreeArea\',-1)">Area Libre</button></td></tr>';
		innerHtml += '</tr>';


		innerHtml += '<tr>';
		innerHtml += '<td><button onclick="showNewTabObjectModal()">+</button></td><td>Objetos</td>';
		for(var i = 0;i < definedObjectNames.length; i++){
			innerHtml += '<td><button id="objectButton_'+i+'" onclick="ontabClick(\'Object\','+i+')">'+definedObjectNames[i]+'</button><button onclick="removeObjectWithIndex('+i+')" >x</button></td>';
		}
		innerHtml += '</tr>';


		innerHtml += '<tr>';
		innerHtml += '<tr><td><button onclick="showNewTabBehaviourModal()">+</button></td><td>Comportamientos</td></tr>';
		for(var i = 0;i < definedBehaviourNames.length; i++){
			innerHtml += '<td><button id="behaviourButton_'+i+'" onclick="ontabClick(\'Behaviour\','+i+')">'+definedBehaviourNames[i]+'</button><button onclick="removeBehaviourWithIndex('+i+')" >x</button></td>';
		}
		innerHtml += '</tr>';

		$('#tabsTable')[0].innerHTML = innerHtml;
	}


	function removeObjectWithIndex(anIndex){
		definedObjectXmlContent.splice(anIndex, 1);
		definedObjectNames.splice(anIndex, 1);
		if(definedObjectXmlContent.length > 0){
			if(anIndex == 0){
				ontabClick('Object',0);
			}else{
				ontabClick('Object',anIndex-1);
			}
		}else{
			ontabClick('FreeArea',-1);
		}
	}

	function removeBehaviourWithIndex(anIndex){
		definedBehaviourXmlContent.splice(anIndex, 1);
		definedBehaviourNames.splice(anIndex, 1);
		if(definedBehaviourXmlContent.length > 0){
			if(anIndex == 0){
				ontabClick('Behaviour',0);
			}else{
				ontabClick('Behaviour',anIndex-1);
			}
		}else{
			ontabClick('FreeArea',-1);
		}
	}

	function closeModal(){
		document.getElementById("box").style.display = "none";
	}

	function showNewTabObjectModal(){
		document.getElementById("modalTitle").innerHTML = "Nuevo Objeto";
		document.getElementById("box").style.display = "block";	
		document.getElementById("createNewTabObjectButton").style.display = "block";
		document.getElementById("createNewTabBehaviourButton").style.display = "none";
	}

	function showNewTabBehaviourModal(){
		document.getElementById("modalTitle").innerHTML = "Nuevo Comportamiento";
		document.getElementById("box").style.display = "block";	
		document.getElementById("createNewTabObjectButton").style.display = "none";
		document.getElementById("createNewTabBehaviourButton").style.display = "block";
	}

	function createNewTabObject(SAVE_MODE){
		var proposedName = $('#newGlobalName').val();
		if(proposedName != undefined && proposedName != null && proposedName != ''){
			if(definedObjectNames.includes(proposedName) ||  definedBehaviourNames.includes(proposedName)){
				alert('Este nombre ya esta siendo utilizado');
			}else{
				var content_tmp = [];
				if(SAVE_MODE == 'SAVE_WORKSPACE'){//SAVE CURRENT WORKSPACE AS TAB
					var xmlSerializer = new XMLSerializer();
					var contentList = getWorkspaceXmlContentAsList();
					for(var i = 0; i < contentList.length; i++){
						content_tmp.push(xmlSerializer.serializeToString(contentList[i]));
					}
				}			
				definedObjectNames.push(proposedName);
				definedObjectXmlContent.push(content_tmp);

				workspace.clear();
				redrawTabs();

				currentTab = 'Object';
				currentIndex = definedObjectXmlContent.length - 1;
				selectCurrentTab();
			}
			$('#newGlobalName').val('');
			document.getElementById("box").style.display = "none";
		}
	}

	function createNewTabBehaviour(SAVE_MODE){
		var proposedName = $('#newGlobalName').val();
		if(proposedName != undefined && proposedName != null && proposedName != ''){
			if(definedObjectNames.includes(proposedName) ||  definedBehaviourNames.includes(proposedName)){
				alert('Este nombre ya esta siendo utilizado');
			}else{
				var content_tmp = [];
				if(SAVE_MODE == 'SAVE_WORKSPACE'){//SAVE CURRENT WORKSPACE AS TAB
					var xmlSerializer = new XMLSerializer();
					var contentList = getWorkspaceXmlContentAsList();
					for(var i = 0; i < contentList.length; i++){
						content_tmp.push(xmlSerializer.serializeToString(contentList[i]));
					}
				}			
				definedBehaviourNames.push(proposedName);
				definedBehaviourXmlContent.push(content_tmp);

				workspace.clear();
				redrawTabs();

				currentTab = 'Behaviour';
				currentIndex = definedBehaviourXmlContent.length - 1;
				selectCurrentTab();
			}
			$('#newGlobalName').val('');
			document.getElementById("box").style.display = "none";
		}
	}


</script>

</html>